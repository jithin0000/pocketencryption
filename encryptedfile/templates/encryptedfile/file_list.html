{% extends 'base/base.html' %}

{% block content %}
    <!-- {% include 'base/navbar.html' %} -->

    <section>
        {% include 'base/second_navbar.html' %}

        <div class="container mt-5">
            <div class="row">
                <div class="col">
                    <h3> Files </h3>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <a href="{% url 'add_file' %}" class="btn">upload new file</a>
                </div>
            </div>

            <div class="row">
                {% for item in object_list %}
                    <div class="col s4">
                        <div class="card image-card">
                            <h4 class="center-align" style="padding: 18px 4px;">{{ item.file_name }}</h4>
                            <div class="card-content">
                                <p> uploaded at : {{ item.created_at }}</p>
                            </div>
                            <div class="card-action">
                                <a href="#" class="blue-text">view file</a>
                                <a data-id="{{ item.id }}" id="dowload-btn" href="#"><i class="material-icons">vertical_align_bottom</i></a>
                                <a href="#"><i class="material-icons">delete</i></a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

        </div>
    </section>

{% endblock %}


{% block js %}
    <script>

        $(document).ready(function () {


            const image_url = document.getElementById('image_url');

            $('.image-card #dowload-btn').click(function (e) {

                let password = prompt("Enter password ");

                const itemId = $(this).attr('data-id');
                if (password !== "") {
                    dowloadImageUsingKey($(this), itemId, password);
                }else{
                    alert("nothing Entered")
                }


            });

            function dowloadImageUsingKey(element, itemId,password) {
                $.ajax({
                    url: "/files/download/" + parseInt(itemId),
                    method: 'post',
                    data: {
                        'data': password
                    },
                    success: data => {
                        console.log(data)

                        if (data.isAutheticated) {
                            let a = document.createElement('a');

                            let icon = document.createElement('i');
                            icon.className = "material-icons";
                            icon.innerText = "cloud_download";

                            a.appendChild(icon)
                            a.href = "/media/" + data.file
                            a.style.fontWeight = "bold";
                            a.style.textAlign = "right";
                            a.style.margin = "32px 4px";
                            a.style.textTransform = "uppercase";


                            element.css('text-align', 'center')

                            element.parent().parent().append(a)
                        } else {
                            alert("incorrect key")
                        }


                    },
                    failure: error => console.log(error)
                })
            }

        })

    </script>
{% endblock %}
